ekf_filter_node:
  ros__parameters:
    # =============================================================================
    # CORE SETTINGS
    # =============================================================================
    frequency: 30.0                    # Update rate (Hz) - reduced from 50 for stability
    sensor_timeout: 0.5                # Increased timeout for GPS (updates at 1Hz)
    two_d_mode: true                   # Ground robot - no Z movement
    
    # Frame Configuration
    map_frame: map
    odom_frame: odom
    base_link_frame: base_link
    world_frame: odom
    
    # Publishing Options
    publish_tf: true
    publish_acceleration: false
    print_diagnostics: true
    debug: false
    
    # =============================================================================
    # IMU CONFIGURATION (Xsens MTi-320)
    # =============================================================================
    # CRITICAL: Your IMU has -1.79 m/sÂ² bias in X acceleration
    # Solution: Use ONLY orientation and angular velocity, NOT acceleration
    
    imu0: /imu/data
    imu0_config: [
      false, false, false,    # Position (0-2): IMU cannot measure position
      true,  true,  true,     # Orientation (3-5): USE - IMU is accurate for orientation
      false, false, false,    # Linear Velocity (6-8): Don't use
      true,  true,  true,     # Angular Velocity (9-11): USE - gyro is reliable
      false, false, false     # Linear Acceleration (12-14): DON'T USE - has bias!
    ]
    
    imu0_differential: false
    imu0_relative: false                          # Use absolute orientation from IMU
    imu0_queue_size: 10
    imu0_remove_gravitational_acceleration: false  # Let EKF handle gravity internally
    
    # Reject outliers
    imu0_pose_rejection_threshold: 0.8
    imu0_twist_rejection_threshold: 0.8
    imu0_linear_acceleration_rejection_threshold: 0.8
    
    # =============================================================================
    # GPS ODOMETRY CONFIGURATION (from navsat_transform)
    # =============================================================================
    
    odom0: /odometry/gps
    odom0_config: [
      true,  true,  false,    # Position (0-2): USE GPS X, Y position only
      false, false, false,    # Orientation (3-5): GPS doesn't provide orientation
      false, false, false,    # Linear Velocity (6-8): Don't use GPS velocity
      false, false, false,    # Angular Velocity (9-11): GPS doesn't provide
      false, false, false     # Linear Acceleration (12-14): GPS doesn't provide
    ]
    
    odom0_differential: false
    odom0_relative: false
    odom0_queue_size: 10
    
    # GPS rejection thresholds - allow some GPS drift but reject big jumps
    odom0_pose_rejection_threshold: 10.0           # Reject if jump > 10 meters
    odom0_twist_rejection_threshold: 2.0           # Reject if velocity > 2 m/s suddenly
    
    # =============================================================================
    # PROCESS NOISE COVARIANCE
    # =============================================================================
    # How much we expect the state to change per second
    # Order: x, y, z, roll, pitch, yaw, vx, vy, vz, vroll, vpitch, vyaw, ax, ay, az
    
    process_noise_covariance: [
      0.05,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.05,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.06,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.03,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.03,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.06,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.025, 0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.025, 0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.04,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.01,  0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.01,  0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.02,  0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.01,  0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.01,  0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.015
    ]
    
    # =============================================================================
    # INITIAL STATE COVARIANCE
    # =============================================================================
    # Initial uncertainty in the state estimate
    
    initial_estimate_covariance: [
      1.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   1.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   1.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   1.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   1.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   1.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   1.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   1.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   1.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.1,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.1,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.1,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   1.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   1.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   1.0
    ]
